### Timestamp
**2024-10-23 09:34:54 UTC**

### Summary
Below is the updated **design pattern** for integrating **human supervision** into your **FastAPI** + **Streamlit** + **PostgreSQL** stack. The system will allow orchestrated task execution with human-in-the-loop supervision, focusing on critical stages like task review and approval. The solution highlights specific implementations for your database layer, business logic, and UI.

---

### **Design Pattern: Workflow Orchestrator with Human Supervision**

#### **1. Database Layer (PostgreSQL)**:
The database schema will be critical for tracking workflows, tasks, states, and human interventions. Here’s a schema update to manage tasks and workflow states effectively:

- **Task Table**:
   - Fields:
     - `id` (Primary Key)
     - `task_name` (Task description)
     - `status` (e.g., "Pending", "In Progress", "Awaiting Review", "Completed")
     - `created_at`, `updated_at` (Timestamps for state tracking)
     - `profile_id` (Foreign key to the Profile table)
     - `proxy_id` (Foreign key to Proxy table)
     - `service_id` (Foreign key to Service table)
     - `command_string` (Stored command for execution)
     - `result` (Data fetched or generated by automation task)
     - `requires_human_intervention` (Boolean flag)
     - `reviewer_id` (ID of the human reviewer)
     - `retry_count` (Track retries)
     - `error_message` (Track any errors during task execution)

- **Workflow Table**:
   - Fields:
     - `id`
     - `workflow_name`
     - `current_step` (Track current step within the workflow)
     - `task_ids` (Reference to all tasks part of the workflow)

- **Human Review Table**:
   - Fields:
     - `id`
     - `task_id` (Foreign key to Task table)
     - `reviewer_id` (Human reviewer)
     - `review_status` (e.g., "Pending", "Approved", "Rejected")
     - `comments` (Feedback or decisions)
     - `review_timestamp`

   **Associations**:
   - **Tasks** will reference profiles, proxies, and services to execute commands under specific configurations.
   - The **Workflow Table** links multiple tasks, ensuring tasks progress through predefined steps.
   - **Human Review Table** will track every decision and supervisor intervention.

#### **2. Business Logic (FastAPI)**:
FastAPI will handle orchestration, managing task execution, state transitions, and integration with human reviewers.

- **Task Orchestration**:
   - **Task Execution**: When a command is issued, FastAPI will spawn a subprocess (e.g., Playwright via Node.js) to handle the automation. FastAPI will manage the execution and update the task status in the database.
   - **Parallel Tasks**: For workflows with multiple tasks, FastAPI will initiate parallel execution and maintain state tracking for each task in the workflow.
   - **State Transitions**:
     - Track transitions: FastAPI will manage the transition of task states from "Pending" → "In Progress" → "Awaiting Review" → "Completed".
     - Automatic retries: Upon failure, the system can attempt retries, incrementing the `retry_count` field.

- **Human Supervision Logic**:
   - **Human-in-the-Loop**: When a task requires human supervision (`requires_human_intervention`), FastAPI will pause the task and notify a human supervisor.
   - **Supervisor Assignment**: FastAPI will assign a task to a human reviewer, updating the `reviewer_id` in the Task table.
   - **Manual Approval/Feedback**:
     - If the supervisor approves the task, FastAPI will resume workflow execution.
     - If the task is rejected or needs modification, the system will update the task state, awaiting further manual adjustments.

- **Workflow Management**:
   - **Sequential Execution**: For workflows with multiple steps, FastAPI will track the `current_step` and execute tasks in sequence. After each step, the system checks if human supervision is needed before proceeding.
   - **Real-time Updates**: Use WebSockets or SSE (Server-Sent Events) to notify the Streamlit UI when task states are updated, especially for tasks awaiting review.

#### **3. UI Implementation (Streamlit)**:
The **Streamlit** interface will provide human supervisors a dashboard to monitor tasks, approve actions, and provide feedback.

- **Task Overview Dashboard**:
   - **Task List**: Display all tasks with their current status, profile, proxy, and service details. Supervisors can click into tasks to review progress.
   - **Filter Options**: Allow filtering tasks by "Pending", "In Progress", "Awaiting Review", "Completed", etc.
   - **Real-time Updates**: Utilize WebSockets/SSE to show live task updates, so supervisors are immediately notified when a task requires intervention.

- **Task Review Interface**:
   - When a task enters the "Awaiting Review" state, it will appear in the supervisor’s queue.
   - **Detailed Task View**: Show all task details (e.g., profile, proxy, service, result), with options to approve or reject.
   - **Feedback Form**: Provide fields for reviewers to give feedback and comments on the task, which is then logged in the **Human Review Table**.
   - **Decision Buttons**: "Approve", "Reject", or "Request Modification" options that trigger state transitions in FastAPI.

- **Workflow Visualization**:
   - Display visual progress of a workflow (e.g., as a flowchart or timeline), showing the current step, completed steps, and any tasks awaiting review.

#### **4. Automation with Playwright**:
- **Playwright Subprocess Execution**:
   - FastAPI will dynamically compose commands based on the task configuration (profile, proxy, service) and send these commands to the Node.js subprocess for execution.
   - **Error Handling**: If Playwright encounters an error (e.g., network issues, login failures), it sends the error message back to FastAPI, which updates the task's status and potentially escalates to a human supervisor.

#### **5. Notification and Escalation**:
- **Notifications**:
   - **Streamlit Notifications**: Integrate notifications within the UI (e.g., banners, toasts) when tasks require supervisor input.
   - **External Alerts**: Send notifications (via email or Slack) when a critical task is blocked awaiting human approval or has failed repeatedly.

- **Escalation Logic**:
   - If tasks are pending review for too long or fail after multiple retries, FastAPI can escalate to higher-level supervisors with alerts.

---

### **Next Steps**:
1. **Define Database Models**: Implement the PostgreSQL schema with task, workflow, and human review models in SQLAlchemy.
2. **Build Orchestration Logic**: Implement FastAPI's task orchestration, including state transitions and handling human interventions.
3. **Develop Streamlit UI**: Build out the task dashboard and review interfaces for human supervisors.
4. **Integrate Automation**: Ensure Playwright subprocesses are triggered with the correct configurations (profile, proxy, services).

---

### Response Details
- **Lines**: 66
- **Characters**: 5,241

### Filename
```bash
nvim human_supervised_task_workflow.md
```
